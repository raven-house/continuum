version: '3.8'

services:
  # MongoDB Database
  mongodb:
    image: mongo:7
    container_name: continuum-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME:-root}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-password}
      MONGO_INITDB_DATABASE: ${CONTINUUM_DB_NAME:-continuum}
    volumes:
      - mongodb_data:/data/db
      - ./database/init.js:/docker-entrypoint-initdb.d/init.js:ro
    networks:
      - continuum-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Event Indexer (Functions)
  indexer:
    build:
      context: .
      dockerfile: functions/Dockerfile
    container_name: continuum-indexer
    restart: unless-stopped
    depends_on:
      mongodb:
        condition: service_healthy
    environment:
      # Database
      CONTINUUM_DB_CONNECTION_STRING: ${CONTINUUM_DB_CONNECTION_STRING:-mongodb://root:password@mongodb:27017}
      CONTINUUM_DB_NAME: ${CONTINUUM_DB_NAME:-continuum}
      
      # Indexer Configuration
      CONTINUUM_INDEXER_INTERVAL: ${CONTINUUM_INDEXER_INTERVAL:-30000}
      CONTINUUM_INDEXER_BLOCK_RANGE: ${CONTINUUM_INDEXER_BLOCK_RANGE:-14}
      CONTINUUM_INDEXER_MAX_RETRIES: ${CONTINUUM_INDEXER_MAX_RETRIES:-3}
      
      # Aztec Node URLs
      CONTINUUM_AZTEC_NODE_URL_DEVNET: ${CONTINUUM_AZTEC_NODE_URL_DEVNET:-}
      CONTINUUM_AZTEC_NODE_URL_TESTNET: ${CONTINUUM_AZTEC_NODE_URL_TESTNET:-}
      CONTINUUM_AZTEC_NODE_URL_SANDBOX: ${CONTINUUM_AZTEC_NODE_URL_SANDBOX:-http://sandbox:8080}
      
      # Artifacts
      CONTINUUM_ARTIFACTS_PATH: ${CONTINUUM_ARTIFACTS_PATH:-/app/artifacts}
      
      # Node Environment
      NODE_ENV: ${NODE_ENV:-production}
    volumes:
      - ./artifacts:/app/artifacts:ro
      - ./artifacts.json:/app/artifacts.json:ro
      - indexer_logs:/app/logs
    networks:
      - continuum-network
    command: ["npm", "run", "start"]

  # REST API Server
  api:
    build:
      context: .
      dockerfile: api/Dockerfile
    container_name: continuum-api
    restart: unless-stopped
    ports:
      - "${CONTINUUM_API_PORT:-3000}:3000"
    depends_on:
      mongodb:
        condition: service_healthy
    environment:
      # Database
      CONTINUUM_DB_CONNECTION_STRING: ${CONTINUUM_DB_CONNECTION_STRING:-mongodb://root:password@mongodb:27017}
      CONTINUUM_DB_NAME: ${CONTINUUM_DB_NAME:-continuum}
      
      # API Configuration
      CONTINUUM_API_PORT: ${CONTINUUM_API_PORT:-3000}
      CONTINUUM_API_HOST: ${CONTINUUM_API_HOST:-0.0.0.0}
      CONTINUUM_CORS_ORIGIN: ${CONTINUUM_CORS_ORIGIN:-*}
      
      # Artifacts
      CONTINUUM_ARTIFACTS_PATH: ${CONTINUUM_ARTIFACTS_PATH:-/app/artifacts}
      
      # Node Environment
      NODE_ENV: ${NODE_ENV:-production}
    volumes:
      - ./artifacts:/app/artifacts:ro
      - ./artifacts.json:/app/artifacts.json:ro
    networks:
      - continuum-network
    command: ["npm", "run", "start"]

volumes:
  mongodb_data:
    name: continuum_mongodb_data
  indexer_logs:
    name: continuum_indexer_logs

networks:
  continuum-network:
    name: continuum-network
    driver: bridge
